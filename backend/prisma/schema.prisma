// backend/prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- ENUMS DE SISTEMA ---
enum Cargo {
  Gerente
  Agente_Social
  Especialista
}

enum CaseStatus {
  AGUARDANDO_ACOLHIDA
  EM_ACOLHIDA
  AGUARDANDO_DISTRIBUICAO_PAEFI
  EM_ACOMPANHAMENTO_PAEFI
  DESLIGADO
}

enum LogAction {
  CRIACAO
  MUDANCA_STATUS
  ATRIBUICAO
  DESLIGAMENTO
  EVOLUCAO_CRIADA
  AGENDAMENTO_CRIADO
  PAF_CRIADO
  PAF_ATUALIZADO
  ANEXO_ADICIONADO
  OUTRO
}

// --- MODELS ---

model User {
  id                    String        @id @default(uuid())
  nome                  String
  email                 String        @unique
  senha                 String
  cargo                 Cargo
  ativo                 Boolean       @default(true)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  casosDeAcolhida       Case[]        @relation("AgenteAcolhida")
  casosDeAcompanhamento Case[]        @relation("EspecialistaPAEFI")
  casosCriados          Case[]        @relation("CasosCriados")
  evolucoes             Evolucao[]    @relation("EvolucoesDoAutor")
  pafsCriados           Paf[]         @relation("PafsDoAutor")
  pafVersoes            PafVersion[]  @relation("VersoesDoAutor")
  agendamentos          Agendamento[] @relation("AgendamentosDoResponsavel")
  logsGerados           CaseLog[]     @relation("LogsDoAutor")
  anexosEnviados        Anexo[]       @relation("AnexosDoAutor")

  @@index([cargo])
}

model Case {
  id                  String    @id @default(uuid())
  nomeCompleto        String
  cpf                 String    @unique
  nascimento          DateTime
  
  sexo                String
  urgencia            String
  // [NOVO] Campo numérico para ordenação estrita (4=Crítica, 1=Baixa)
  pesoUrgencia        Int       @default(1) 
  
  violacao            String
  categoria           String
  
  telefone            String
  endereco            String
  dataEntrada         DateTime  @default(now())
  orgaoDemandante     String
  numeroSei           String?
  linkSei             String?
  observacoes         String?
  status              CaseStatus @default(AGUARDANDO_ACOLHIDA)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  criadoPor           User      @relation("CasosCriados", fields: [criadoPorId], references: [id])
  criadoPorId         String

  agenteAcolhida      User?     @relation("AgenteAcolhida", fields: [agenteAcolhidaId], references: [id])
  agenteAcolhidaId    String?

  especialistaPAEFI   User?     @relation("EspecialistaPAEFI", fields: [especialistaPAEFIId], references: [id])
  especialistaPAEFIId String?

  evolucoes           Evolucao[]
  paf                 Paf?
  agendamentos        Agendamento[]
  logs                CaseLog[]
  anexos              Anexo[]

  beneficios          String[]   @default([])
  dataInicioPAEFI     DateTime?
  dataDesligamento    DateTime?
  motivoDesligamento  String?
  parecerFinal        String?
  deletado            Boolean    @default(false)
  dataDeletado        DateTime?

  @@index([status])
  @@index([dataEntrada])
  @@index([pesoUrgencia]) // Índice para garantir performance na ordenação
}

model Evolucao {
  id        String   @id @default(uuid())
  conteudo  String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  caso      Case     @relation(fields: [casoId], references: [id], onDelete: Cascade)
  casoId    String
  autor     User     @relation("EvolucoesDoAutor", fields: [autorId], references: [id])
  autorId   String
}

model Paf {
  id          String   @id @default(uuid())
  diagnostico String   @db.Text
  objetivos   String   @db.Text
  estrategias String   @db.Text
  deadline    DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  caso        Case     @relation(fields: [casoId], references: [id], onDelete: Cascade)
  casoId      String   @unique
  autor       User     @relation("PafsDoAutor", fields: [autorId], references: [id])
  autorId     String
  versoes     PafVersion[]
  versaoAtual Int      @default(1)
}

model PafVersion {
  id          String   @id @default(uuid())
  diagnostico String   @db.Text
  objetivos   String   @db.Text
  estrategias String   @db.Text
  deadline    DateTime
  savedAt     DateTime @default(now())
  paf         Paf      @relation(fields: [pafId], references: [id], onDelete: Cascade)
  pafId       String
  autor       User     @relation("VersoesDoAutor", fields: [autorId], references: [id])
  autorId     String
  versaoNumero Int     @default(1)
}

model Agendamento {
  id            String   @id @default(uuid())
  titulo        String
  data          DateTime
  observacoes   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  responsavel   User   @relation("AgendamentosDoResponsavel", fields: [responsavelId], references: [id])
  responsavelId String
  caso          Case   @relation(fields: [casoId], references: [id], onDelete: Cascade)
  casoId        String
}

model CaseLog {
  id            String    @id @default(uuid())
  acao          LogAction
  descricao     String
  valorAnterior String?
  valorNovo     String?
  createdAt     DateTime  @default(now())
  caso          Case      @relation(fields: [casoId], references: [id], onDelete: Cascade)
  casoId        String
  autor         User      @relation("LogsDoAutor", fields: [autorId], references: [id])
  autorId       String
}

model Anexo {
  id          String   @id @default(uuid())
  nome        String
  tipo        String
  url         String
  tamanho     Int?
  createdAt   DateTime @default(now())
  caso        Case     @relation(fields: [casoId], references: [id], onDelete: Cascade)
  casoId      String
  autor       User     @relation("AnexosDoAutor", fields: [autorId], references: [id])
  autorId     String
}